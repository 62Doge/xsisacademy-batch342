<th:block th:fragment="style">
  <style>
    #forgotPasswordButton:hover {
      text-decoration: underline;
      color: #0056b3;
    }
  </style>
</th:block>

<th:block th:fragment="script">
  <script>
    const resetPasswordRequest = {
      email: null,
      otp: null,
      newPassword: null,
      confirmPassword: null,
    };

    function clearResetPasswordRequest() {
      resetPasswordRequest.email = null;
      resetPasswordRequest.otp = null;
      resetPasswordRequest.newPassword = null;
      resetPasswordRequest.confirmPassword = null;
    }

    $(document).on("click", "#forgotPasswordButton", function (e) {
      e.preventDefault();
      $("#baseModalTitle").text("");
      $("#baseModal").modal("hide");

      $("#baseModal").on("hidden.bs.modal", function () {
        $("#baseModalTitle").text("Lupa Password");

        $("#baseModalBody").html(`
<div class="nav-align-left">
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <button data-id="1" type="button" class="nav-link forgot-password active" role="tab" data-bs-toggle="tab" data-bs-target="#forgot-password-send-otp">Kirim OTP</button>
    </li>
    <li class="nav-item">
      <button data-id="2" type="button" class="nav-link forgot-password disabled" role="tab" data-bs-toggle="tab" data-bs-target="#forgot-password-verify-email">Verifikasi Email</button>
    </li>
    <li class="nav-item">
      <button data-id="3" type="button" class="nav-link forgot-password disabled" role="tab" data-bs-toggle="tab" data-bs-target="#forgot-password-set-new-password">Buat Password Baru</button>
    </li>
  </ul>
  
  <div class="tab-content p-3">
    <!-- Tab Kirim OTP -->
    <div data-id="1" class="tab-pane forgot-password fade show active" id="forgot-password-send-otp">
      <form>
        <div class="mb-3">
          <label for="forgotPasswordEmailInput" class="form-label">Email</label>
          <input type="email" class="form-control" id="forgotPasswordEmailInput" placeholder="Masukkan email Anda" required>
          <p class="error text-danger invisible fst-italic">error message</p>
        </div>
        <button id="sendOtpButton" class="btn btn-primary w-100">Kirim OTP</button>
      </form>
    </div>

    <!-- Tab Verifikasi Email -->
    <div data-id="2" class="tab-pane forgot-password fade" id="forgot-password-verify-email">
      <form id="verifyOtpForm">
        <div class="mb-3">
          <label for="otpInput" class="form-label">Kode OTP</label>
          <input type="text" class="form-control" id="otpInput" placeholder="Masukkan kode OTP" required>
          <p class="error text-danger invisible fst-italic">error message</p>
          <div id="countdownTimerContainer" class="text-muted mt-2 d-flex justify-content-center">

          </div>
        </div>
        <button type="submit" class="btn btn-primary w-100">Verifikasi OTP</button>
      </form>
    </div>

    <!-- Tab Buat Password Baru -->
    <div data-id="3" class="tab-pane forgot-password fade" id="forgot-password-set-new-password">
      <form id="setNewPasswordForm">
        <div class="mb-3">
          <label for="newPasswordInput" class="form-label">Password Baru</label>
          <input type="password" class="form-control" id="newPasswordInput" placeholder="Masukkan password baru" required>
        </div>
        <div class="mb-3">
          <label for="confirmPasswordInput" class="form-label">Konfirmasi Password</label>
          <input type="password" class="form-control" id="confirmPasswordInput" placeholder="Konfirmasi password baru" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Simpan Password Baru</button>
      </form>
    </div>
  </div>
</div>

    `);

        $("#baseModal").modal("show");

        $(this).off("hidden.bs.modal");
      });
    });

    function moveTab(buttonSelector, contentForm) {
      $(".tab-pane").removeClass("active show");
      $(".nav-item button").removeClass("active");
      $(".nav-item button").addClass("disabled");

      $(buttonSelector).removeClass("disabled");
      $(buttonSelector).addClass("active");
      $(contentForm).addClass("active show");
    }

    let countdownDuration = 5 * 3; // 3 menit
    let countdownInterval;

    function startCountdown() {
      clearInterval(countdownInterval);
      let remainingTime = countdownDuration;

      countdownInterval = setInterval(function () {
        if (remainingTime <= 0) {
          clearInterval(countdownInterval);
          $("#countdownTimerContainer").html(`
                      <button id="resendOtp" class="btn btn-outline-primary" type="button">
                        Kirim ulang <i class="bx bx-revision">
                      </i></button>
          `);
        } else {
          let minutes = Math.floor(remainingTime / 60);
          let seconds = remainingTime % 60;
          seconds = seconds < 10 ? "00" + seconds : seconds;
          $("#countdownTimerContainer").text(
            "Kirim ulang kode OTP dalam: " + minutes + ":" + seconds
          );
          remainingTime--;
        }
      }, 1000);
    }

    // $(document).on("click", "#resendOtp", function (e) {
    //   e.preventDefault();
    //   $.ajax({
    //     type: "post",
    //     url: BE_BASE_URL + "/auth/forgot-password",
    //     data: JSON.stringify({
    //       email: inputVal,
    //     }),
    //     contentType: "application/json",
    //     success: function (response) {
    //       resetPasswordRequest.email;

    //       $(".nav-link.forgot-password[data-id=1]").addClass("disabled");
    //       $(".nav-link.forgot-password[data-id=2]").removeClass("disabled");

    //       // show countdown

    //       startCountdown();
    //     },
    //     error(jqXHR, textStatus, errorThrown) {
    //       if (jqXHR.status == 404) {
    //         showValidationErrorMessage(
    //           validateErrorMessage,
    //           jqXHR.responseJSON.data
    //         );
    //       }
    //     },
    //   });
    // });

    function clearErrorValidationMessage() {
      $("form div .error").addClass("invisible");
      $("form div .error").text("");
    }

    function showValidationErrorMessage(jqElm, errorMessage) {
      jqElm.removeClass("invisible");
      jqElm.text(errorMessage);

      setTimeout(() => {
        jqElm.addClass("invisible");
      }, 1500);
    }

    $(document).on("click", "#sendOtpButton", function (e) {
      e.preventDefault();
      const button = $(this);
      const inputVal = $("#forgotPasswordEmailInput").val();
      const validateErrorMessage = button.parent().find(".error");
      // from https://www.mailercheck.com/articles/email-validation-javascript
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (inputVal == "") {
        showValidationErrorMessage(
          validateErrorMessage,
          "Email tidak boleh kosong"
        );
        return;
      }

      if (!emailPattern.test(inputVal)) {
        showValidationErrorMessage(
          validateErrorMessage,
          "Email tidak valid (contoh: @domain.com)"
        );
        return;
      }

      button.addClass("disabled");

      $.ajax({
        type: "post",
        url: BE_BASE_URL + "/auth/forgot-password",
        data: JSON.stringify({
          email: inputVal,
        }),
        contentType: "application/json",
        success: function (response) {
          resetPasswordRequest.email;

          $(".nav-link.forgot-password[data-id=1]").addClass("disabled");
          $(".nav-link.forgot-password[data-id=2]").removeClass("disabled");
          moveTab(
            ".nav-link.forgot-password[data-id=2]",
            ".tab-pane.forgot-password[data-id=2]"
          );

          // show countdown
          startCountdown();
        },
        error(jqXHR, textStatus, errorThrown) {
          console.log(jqXHR);

          if (jqXHR.status == 404 || jqXHR.status == 429) {
            showValidationErrorMessage(
              validateErrorMessage,
              jqXHR.responseJSON.data
            );
          } else if (jqXHR.status == 500) {
            showValidationErrorMessage(
              validateErrorMessage,
              jqXHR.responseJSON.message
            );
          }
          setTimeout(() => {
            button.removeClass("disabled");
          }, 1000);
        },
      });

      // $(".nav-link.forgot-password[data-id=2]").removeClass("disabled");
    });
  </script>
</th:block>
